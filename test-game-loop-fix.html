<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Game Loop Fix - Project Ara</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
        }
        
        #gameCanvas {
            border: 1px solid #0f0;
            background: #001122;
            display: block;
            margin: 20px auto;
        }
        
        .status {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #0f0;
            background: rgba(0, 50, 0, 0.3);
        }
        
        .hud {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border: 1px solid #0f0;
            border-radius: 5px;
            min-width: 200px;
        }
        
        .hud div {
            margin: 5px 0;
        }
        
        .success {
            color: #0f0;
        }
        
        .error {
            color: #f00;
        }
        
        .warning {
            color: #ff0;
        }
        
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        
        button:hover {
            background: #0a0;
        }
    </style>
</head>
<body>
    <h1>üîß Test Game Loop Fix - Project Ara</h1>
    
    <div class="status">
        <h3>Estado del Test:</h3>
        <div id="testStatus">Iniciando test...</div>
    </div>
    
    <div class="hud">
        <h4>üìä M√©tricas del Juego:</h4>
        <div id="planetsCount">Planetas: 0</div>
        <div id="fleetsCount">Flotas: 0</div>
        <div id="renderCount">Renders: 0</div>
        <div id="gameLoopStatus">Game Loop: Detenido</div>
        <div id="rendererStatus">Renderer: No conectado</div>
    </div>
    
    <!-- Canvas del juego -->
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <div class="status">
        <button onclick="startTest()">üöÄ Iniciar Test</button>
        <button onclick="stopTest()">‚èπÔ∏è Detener Test</button>
        <button onclick="clearLogs()">üßπ Limpiar Logs</button>
    </div>
    
    <div class="status">
        <h3>üìã Log del Test:</h3>
        <div id="testLog" style="max-height: 300px; overflow-y: auto; background: #001; padding: 10px; font-size: 12px;"></div>
    </div>

    <script type="module">
        let gameLoader = null;
        let testInterval = null;
        let renderCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'success';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`üîß TEST: ${message}`);
        }
        
        window.startTest = async function() {
            try {
                log('üîß TEST: Iniciando test del game loop corregido...', 'info');
                
                // Importar GameLoader
                log('üîß TEST: Importando GameLoader...', 'info');
                const { GameLoader } = await import('./src/ui/GameLoader.js');
                
                // Crear GameLoader
                log('üîß TEST: Creando GameLoader...', 'info');
                gameLoader = new GameLoader();
                
                // Cargar el juego
                log('üîß TEST: Iniciando carga del juego...', 'info');
                await gameLoader.load();
                
                // Obtener sistemas cargados
                const systems = gameLoader.getLoadedSystems();
                
                if (!systems) {
                    throw new Error('No se pudieron cargar los sistemas');
                }
                
                log('üîß TEST: ‚úÖ Sistemas cargados correctamente', 'success');
                
                // Verificar que el renderer est√© conectado al GameEngine
                if (systems.gameEngine && systems.gameEngine.renderer) {
                    log('üîß TEST: ‚úÖ CanvasRenderer conectado al GameEngine', 'success');
                    document.getElementById('rendererStatus').textContent = 'Renderer: ‚úÖ Conectado';
                } else {
                    log('üîß TEST: ‚ùå CanvasRenderer NO conectado al GameEngine', 'error');
                    document.getElementById('rendererStatus').textContent = 'Renderer: ‚ùå No conectado';
                }
                
                // Verificar que el game loop est√© funcionando
                if (systems.gameEngine && systems.gameEngine.stateManager.isRunning) {
                    log('üîß TEST: ‚úÖ Game loop funcionando', 'success');
                    document.getElementById('gameLoopStatus').textContent = 'Game Loop: ‚úÖ Funcionando';
                } else {
                    log('üîß TEST: ‚ùå Game loop NO funcionando', 'error');
                    document.getElementById('gameLoopStatus').textContent = 'Game Loop: ‚ùå Detenido';
                }
                
                // Iniciar monitoreo de m√©tricas
                startMetricsMonitoring(systems);
                
                log('üîß TEST: ‚úÖ Test completado exitosamente', 'success');
                document.getElementById('testStatus').innerHTML = '<span class="success">‚úÖ Test completado - Juego funcionando</span>';
                
            } catch (error) {
                log(`üîß TEST: ‚ùå Error en el test: ${error.message}`, 'error');
                document.getElementById('testStatus').innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                console.error('‚ùå Error completo:', error);
            }
        };
        
        function startMetricsMonitoring(systems) {
            if (testInterval) clearInterval(testInterval);
            
            testInterval = setInterval(() => {
                try {
                    if (systems.gameEngine) {
                        const planets = systems.gameEngine.getAllPlanets();
                        const fleets = systems.gameEngine.getAllFleets();
                        
                        document.getElementById('planetsCount').textContent = `Planetas: ${planets ? planets.length : 0}`;
                        document.getElementById('fleetsCount').textContent = `Flotas: ${fleets ? fleets.length : 0}`;
                        
                        // Contar renders (aproximado)
                        if (systems.gameEngine.renderer && systems.gameEngine.renderer.renderState) {
                            const currentRenderCount = systems.gameEngine.renderer.renderState.frameCount || 0;
                            document.getElementById('renderCount').textContent = `Renders: ${currentRenderCount}`;
                        }
                        
                        // Verificar estado del game loop
                        const isRunning = systems.gameEngine.stateManager.isRunning;
                        document.getElementById('gameLoopStatus').textContent = `Game Loop: ${isRunning ? '‚úÖ Funcionando' : '‚ùå Detenido'}`;
                    }
                } catch (error) {
                    log(`‚ö†Ô∏è Error actualizando m√©tricas: ${error.message}`, 'warning');
                }
            }, 1000);
        }
        
        window.stopTest = function() {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            if (gameLoader) {
                try {
                    gameLoader.destroy();
                    gameLoader = null;
                    log('üîß TEST: GameLoader destruido', 'info');
                } catch (error) {
                    log(`‚ö†Ô∏è Error destruyendo GameLoader: ${error.message}`, 'warning');
                }
            }
            
            document.getElementById('testStatus').innerHTML = '<span class="warning">‚èπÔ∏è Test detenido</span>';
            document.getElementById('gameLoopStatus').textContent = 'Game Loop: Detenido';
            document.getElementById('rendererStatus').textContent = 'Renderer: No conectado';
        };
        
        window.clearLogs = function() {
            document.getElementById('testLog').innerHTML = '';
        };
        
        // Auto-iniciar el test
        log('üîß TEST: P√°gina cargada, listo para iniciar test', 'info');
    </script>
</body>
</html> 