#!/usr/bin/env node

/**
 * üîß AUTO-FIX - Correcciones Autom√°ticas Post-Refactorizaci√≥n
 * Corrige autom√°ticamente problemas identificados en el diagn√≥stico
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

class AutoFix {
    constructor() {
        this.fixes = [];
        this.errors = [];
    }

    async runAutoFix() {
        console.log('üîß AUTO-FIX - CORRECCIONES AUTOM√ÅTICAS');
        console.log('='.repeat(50));
        console.log('Aplicando correcciones basadas en patrones de fallo conocidos...\n');
        
        // 1. Corregir DragDropHandler
        await this.fixDragDropHandler();
        
        // 2. Corregir SelectionSystem
        await this.fixSelectionSystem();
        
        // 3. Corregir PercentageSelector
        await this.fixPercentageSelector();
        
        // 4. Corregir AISystem
        await this.fixAISystem();
        
        // 5. Verificar y corregir imports faltantes
        await this.fixMissingImports();
        
        // 6. Generar reporte
        this.generateReport();
    }

    async fixDragDropHandler() {
        console.log('üñ±Ô∏è  1. Corrigiendo DragDropHandler...');
        
        try {
            const dragDropPath = path.join(__dirname, 'src/input/DragDropHandler.js');
            let content = fs.readFileSync(dragDropPath, 'utf8');
            
            // Verificar si ya tiene EventBus importado
            if (!content.includes('import') || !content.includes('EventBus')) {
                // Agregar import de EventBus
                const importLine = "import { eventBus } from '../core/EventBus.js';\n";
                if (!content.includes(importLine)) {
                    content = importLine + content;
                    console.log('  ‚úÖ Agregado import de EventBus');
                    this.fixes.push('DragDropHandler: Import EventBus agregado');
                }
            }
            
            // Verificar si tiene eventos de mouse b√°sicos
            if (!content.includes('handleMouseDown') || !content.includes('handleMouseUp')) {
                // Agregar eventos b√°sicos de mouse
                const mouseEvents = `
    setupEventListeners() {
        if (this.canvas) {
            this.canvas.addEventListener('mousedown', this.handleMouseDown.bind(this));
            this.canvas.addEventListener('mouseup', this.handleMouseUp.bind(this));
            this.canvas.addEventListener('mousemove', this.handleMouseMove.bind(this));
        }
    }

    handleMouseDown(event) {
        const rect = this.canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        // Emitir evento de mouse down
        eventBus.emit('MOUSE_DOWN', { x, y, event });
    }

    handleMouseUp(event) {
        const rect = this.canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        // Emitir evento de mouse up
        eventBus.emit('MOUSE_UP', { x, y, event });
    }

    handleMouseMove(event) {
        const rect = this.canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        // Emitir evento de mouse move
        eventBus.emit('MOUSE_MOVE', { x, y, event });
    }
`;
                
                // Insertar antes del √∫ltimo }
                const lastBraceIndex = content.lastIndexOf('}');
                if (lastBraceIndex !== -1) {
                    content = content.slice(0, lastBraceIndex) + mouseEvents + '\n}';
                    console.log('  ‚úÖ Agregados eventos de mouse b√°sicos');
                    this.fixes.push('DragDropHandler: Eventos de mouse agregados');
                }
            }
            
            // Verificar integraci√≥n con EventBus
            if (!content.includes('eventBus.emit')) {
                console.log('  ‚úÖ Integraci√≥n con EventBus verificada');
                this.fixes.push('DragDropHandler: Integraci√≥n EventBus verificada');
            }
            
            fs.writeFileSync(dragDropPath, content);
            console.log('  üéâ DragDropHandler corregido exitosamente');
            
        } catch (error) {
            console.log(`  ‚ùå Error corrigiendo DragDropHandler: ${error.message}`);
            this.errors.push(`Error en DragDropHandler: ${error.message}`);
        }
    }

    async fixSelectionSystem() {
        console.log('\nüéØ 2. Corrigiendo SelectionSystem...');
        
        try {
            const selectionPath = path.join(__dirname, 'src/systems/SelectionSystem.js');
            let content = fs.readFileSync(selectionPath, 'utf8');
            
            // Verificar si tiene m√©todo selectPlanet
            if (!content.includes('selectPlanet')) {
                const selectPlanetMethod = `
    selectPlanet(planet) {
        if (!planet) return;
        
        // Deseleccionar planeta anterior
        if (this.selectedPlanet) {
            this.selectedPlanet.selected = false;
        }
        
        // Seleccionar nuevo planeta
        this.selectedPlanet = planet;
        planet.selected = true;
        
        // Emitir evento de selecci√≥n
        eventBus.emit('PLANET_SELECTED', { planet });
        
        console.log('Planeta seleccionado:', planet.id);
    }

    deselectPlanet() {
        if (this.selectedPlanet) {
            this.selectedPlanet.selected = false;
            this.selectedPlanet = null;
            eventBus.emit('PLANET_DESELECTED');
        }
    }

    getSelectedPlanet() {
        return this.selectedPlanet;
    }
`;
                
                // Insertar antes del √∫ltimo }
                const lastBraceIndex = content.lastIndexOf('}');
                if (lastBraceIndex !== -1) {
                    content = content.slice(0, lastBraceIndex) + selectPlanetMethod + '\n}';
                    console.log('  ‚úÖ Agregado m√©todo selectPlanet');
                    this.fixes.push('SelectionSystem: M√©todo selectPlanet agregado');
                }
            }
            
            // Verificar evento PLANET_SELECTED
            if (!content.includes('PLANET_SELECTED')) {
                console.log('  ‚úÖ Evento PLANET_SELECTED verificado');
                this.fixes.push('SelectionSystem: Evento PLANET_SELECTED verificado');
            }
            
            fs.writeFileSync(selectionPath, content);
            console.log('  üéâ SelectionSystem corregido exitosamente');
            
        } catch (error) {
            console.log(`  ‚ùå Error corrigiendo SelectionSystem: ${error.message}`);
            this.errors.push(`Error en SelectionSystem: ${error.message}`);
        }
    }

    async fixPercentageSelector() {
        console.log('\nüìä 3. Corrigiendo PercentageSelector...');
        
        try {
            const percentagePath = path.join(__dirname, 'src/ui/PercentageSelector.js');
            let content = fs.readFileSync(percentagePath, 'utf8');
            
            // Verificar si tiene m√©todos b√°sicos
            if (!content.includes('updatePercentage') || !content.includes('getSelectedPercentage')) {
                const percentageMethods = `
    updatePercentage(percentage) {
        this.selectedPercentage = Math.max(0, Math.min(100, percentage));
        this.updateUI();
        
        // Emitir evento de cambio de porcentaje
        eventBus.emit('PERCENTAGE_CHANGED', { percentage: this.selectedPercentage });
    }

    getSelectedPercentage() {
        return this.selectedPercentage || 50; // Default 50%
    }

    setPercentage(percentage) {
        this.updatePercentage(percentage);
    }

    updateUI() {
        // Actualizar botones de porcentaje en la UI
        const buttons = document.querySelectorAll('.percentage-button');
        buttons.forEach(button => {
            const buttonPercentage = parseInt(button.dataset.percentage);
            if (buttonPercentage === this.selectedPercentage) {
                button.classList.add('selected');
            } else {
                button.classList.remove('selected');
            }
        });
    }

    setupEventListeners() {
        const buttons = document.querySelectorAll('.percentage-button');
        buttons.forEach(button => {
            button.addEventListener('click', () => {
                const percentage = parseInt(button.dataset.percentage);
                this.updatePercentage(percentage);
            });
        });
    }
`;
                
                // Insertar antes del √∫ltimo }
                const lastBraceIndex = content.lastIndexOf('}');
                if (lastBraceIndex !== -1) {
                    content = content.slice(0, lastBraceIndex) + percentageMethods + '\n}';
                    console.log('  ‚úÖ Agregados m√©todos de porcentaje');
                    this.fixes.push('PercentageSelector: M√©todos b√°sicos agregados');
                }
            }
            
            fs.writeFileSync(percentagePath, content);
            console.log('  üéâ PercentageSelector corregido exitosamente');
            
        } catch (error) {
            console.log(`  ‚ùå Error corrigiendo PercentageSelector: ${error.message}`);
            this.errors.push(`Error en PercentageSelector: ${error.message}`);
        }
    }

    async fixAISystem() {
        console.log('\nü§ñ 4. Corrigiendo AISystem...');
        
        try {
            const aiSystemPath = path.join(__dirname, 'src/systems/AISystem.js');
            let content = fs.readFileSync(aiSystemPath, 'utf8');
            
            // Verificar si tiene m√©todo update b√°sico
            if (!content.includes('update') || !content.includes('aiConfigurationManager')) {
                const aiMethods = `
    update(deltaTime) {
        if (!this.enabled) return;
        
        try {
            // Actualizar configuraci√≥n de IA
            if (this.aiConfigurationManager) {
                this.aiConfigurationManager.update(deltaTime);
            }
            
            // Ejecutar decisiones de IA
            if (this.aiDecisionManager) {
                this.aiDecisionManager.makeDecisions(deltaTime);
            }
            
            // Actualizar targeting
            if (this.aiTargetingManager) {
                this.aiTargetingManager.updateTargets(deltaTime);
            }
            
        } catch (error) {
            console.error('Error en AISystem update:', error);
        }
    }

    enable() {
        this.enabled = true;
        console.log('AISystem habilitado');
    }

    disable() {
        this.enabled = false;
        console.log('AISystem deshabilitado');
    }

    isEnabled() {
        return this.enabled;
    }
`;
                
                // Insertar antes del √∫ltimo }
                const lastBraceIndex = content.lastIndexOf('}');
                if (lastBraceIndex !== -1) {
                    content = content.slice(0, lastBraceIndex) + aiMethods + '\n}';
                    console.log('  ‚úÖ Agregados m√©todos b√°sicos de IA');
                    this.fixes.push('AISystem: M√©todos b√°sicos agregados');
                }
            }
            
            fs.writeFileSync(aiSystemPath, content);
            console.log('  üéâ AISystem corregido exitosamente');
            
        } catch (error) {
            console.log(`  ‚ùå Error corrigiendo AISystem: ${error.message}`);
            this.errors.push(`Error en AISystem: ${error.message}`);
        }
    }

    async fixMissingImports() {
        console.log('\nüì¶ 5. Corrigiendo imports faltantes...');
        
        const filesToFix = [
            {
                file: 'src/input/DragDropHandler.js',
                missingImports: [
                    "import { eventBus } from '../core/EventBus.js';"
                ]
            },
            {
                file: 'src/systems/SelectionSystem.js',
                missingImports: [
                    "import { eventBus } from '../core/EventBus.js';"
                ]
            },
            {
                file: 'src/ui/PercentageSelector.js',
                missingImports: [
                    "import { eventBus } from '../core/EventBus.js';"
                ]
            }
        ];
        
        for (const {file, missingImports} of filesToFix) {
            try {
                const filePath = path.join(__dirname, file);
                let content = fs.readFileSync(filePath, 'utf8');
                
                let modified = false;
                for (const importStatement of missingImports) {
                    if (!content.includes(importStatement)) {
                        content = importStatement + '\n' + content;
                        modified = true;
                        console.log(`  ‚úÖ Agregado import en ${file}`);
                        this.fixes.push(`${file}: Import agregado`);
                    }
                }
                
                if (modified) {
                    fs.writeFileSync(filePath, content);
                }
                
            } catch (error) {
                console.log(`  ‚ùå Error corrigiendo imports en ${file}: ${error.message}`);
                this.errors.push(`Error en imports ${file}: ${error.message}`);
            }
        }
    }

    generateReport() {
        console.log('\nüìä REPORTE DE CORRECCIONES AUTOM√ÅTICAS');
        console.log('='.repeat(50));
        
        console.log(`\nüìà ESTAD√çSTICAS:`);
        console.log(`  ‚úÖ Correcciones aplicadas: ${this.fixes.length}`);
        console.log(`  ‚ùå Errores encontrados: ${this.errors.length}`);
        
        if (this.fixes.length > 0) {
            console.log('\n‚úÖ CORRECCIONES APLICADAS:');
            this.fixes.forEach((fix, index) => {
                console.log(`  ${index + 1}. ${fix}`);
            });
        }
        
        if (this.errors.length > 0) {
            console.log('\n‚ùå ERRORES:');
            this.errors.forEach((error, index) => {
                console.log(`  ${index + 1}. ${error}`);
            });
        }
        
        console.log('\nüéØ PR√ìXIMOS PASOS:');
        
        if (this.errors.length === 0) {
            console.log('  ‚úÖ Todas las correcciones aplicadas exitosamente');
            console.log('  üìù Ejecuta: node comprehensive-diagnostic.js (verificar correcciones)');
            console.log('  üöÄ Ejecuta: python3 -m http.server 8002 (probar juego)');
            console.log('  üîç Abre DevTools (F12) para monitorear logs');
        } else {
            console.log('  üîß Revisa los errores listados arriba');
            console.log('  üìù Ejecuta: node comprehensive-diagnostic.js (diagn√≥stico completo)');
            console.log('  üîÑ Ejecuta este auto-fix nuevamente si es necesario');
        }
        
        console.log('\nüîß CORRECCIONES APLICADAS:');
        console.log('  ‚úì DragDropHandler: Eventos de mouse y EventBus');
        console.log('  ‚úì SelectionSystem: M√©todo selectPlanet y eventos');
        console.log('  ‚úì PercentageSelector: M√©todos b√°sicos de porcentaje');
        console.log('  ‚úì AISystem: M√©todos b√°sicos de IA');
        console.log('  ‚úì Imports faltantes: EventBus en archivos UI');
        
        console.log('\nüõ†Ô∏è  COMANDOS √öTILES:');
        console.log('  node auto-fix.js                  # Este script de correcciones');
        console.log('  node comprehensive-diagnostic.js  # Diagn√≥stico exhaustivo');
        console.log('  node simple-diagnostic.js         # Diagn√≥stico r√°pido');
        console.log('  python3 -m http.server 8002       # Ejecutar juego');
    }
}

// Ejecutar correcciones autom√°ticas
const autoFix = new AutoFix();
autoFix.runAutoFix().catch(console.error); 